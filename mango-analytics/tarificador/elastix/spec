%define modname mango-analytics
Summary: Mango Analytics
Name: elastix-%{modname}
Version: 1.0.1
Release: 1
License: GPLv2
Group: Applications/System
Source0: %{modname}_%{version}-%{release}.tgz
BuildRoot: %{_tmppath}/%{name}-%{version}-root
BuildArch: noarch
Prereq: elastix-framework >= 2.2.0-25

%description
Mango Analytics is a cost reporting tool for Elastix PBX

%prep

%setup -n %{modname}

%install
rm -rf $RPM_BUILD_ROOT

mkdir -p $RPM_BUILD_ROOT/usr/share/elastix/module_installer/%{name}-%{version}-%{release}/
mv setup/ $RPM_BUILD_ROOT/usr/share/elastix/module_installer/%{name}-%{version}-%{release}/
mv menu.xml $RPM_BUILD_ROOT/usr/share/elastix/module_installer/%{name}-%{version}-%{release}/

%pre
#Aqui creamos todas las carpetas e instalamos lo necesario para que funcione
#1 - Instalando herramientas de devel
yum groupinstall -y "Development tools" 
yum install -y zlib-devel bzip2-devel openssl-devel ncurses-devel sqlite-devel readline-devel mysql-devel git

#2 - Compilando python 2.7.5
wget http://python.org/ftp/python/2.7.5/Python-2.7.5.tar.bz2
tar xf Python-2.7.5.tar.bz2
cd Python-2.7.5
./configure --prefix=/usr/local
make && make altinstall

#3 - Instalando distribute
wget http://pypi.python.org/packages/source/d/distribute/distribute-0.6.49.tar.gz --no-check-certificate
tar xf distribute-0.6.49.tar.gz
cd distribute-0.6.49
python2.7 setup.py install

#4 - Installing virtualenv and pip
easy_install-2.7 virtualenv

#Creating virtualenv directory and installation paths
mkdir /opt/NEXTOR
virtualenv /opt/NEXTOR/tarificador
source /opt/NEXTOR/tarificador/bin/activate && pip install django==1.5.1 MySQL-python==1.2.4 python-dateutil==2.1 cherrypy==3.2.4 envelopes==0.3 six==1.3.0


mkdir -p /usr/share/elastix/module_installer/%{name}-%{version}-%{release}/  
touch /usr/share/elastix/module_installer/%{name}-%{version}-%{release}/preversion_%{modname}.info
if [ $1 -eq 2 ]; then
	rpm -q --queryformat='%{VERSION}-%{RELEASE}' %{name} > 	/usr/share/elastix/module_installer/%{name}-%{version}-%{release}/preversion_%{modname}.info
fi

%post
pathModule="/usr/share/elastix/module_installer/%{name}-%{version}-%{release}"
# Run installer script to fix up ACLs and add module to Elastix menus.
elastix-menumerge $pathModule/menu.xml

#Nos metemos al virtualenv e inicializamos la bd
source /opt/NEXTOR/tarificador/bin/activate && python tools/initialMySQLSetup.py
mkdir /opt/NEXTOR/tarificador/django-tarificador
cp -R tarificador /opt/NEXTOR/tarificador/django-tarificador/tarificador
python /opt/NEXTOR/tarificador/django-tarificador/tarificador/manage.py syncdb --noinput
python /opt/NEXTOR/tarificador/django-tarificador/tarificador/manage.py collectstatic
python /opt/NEXTOR/tarificador/django-tarificador/tarificador/serve.py > /dev/null &
echo "0 2 * * * source /opt/NEXTOR/tarificador/bin/activate && python /opt/NEXTOR/tarificador/django-tarificador/tarificador/tarifica/tools/importer.py > /dev/null" >> /var/spool/cron/root

%clean
rm -rf $RPM_BUILD_ROOT

%preun
if [ $1 -eq 0 ] ; then # Validation for desinstall this rpm
	echo "Deleting menus"
	elastix-menuremove "%{modname}"
fi

%files

%defattr(-, asterisk, asterisk)
%{_localstatedir}/www/html/*
/usr/share/elastix/module_installer/*

%changelog
* Mon Sep 9 2013 Alfonso Lizarraga <alfonso@nextortelecom.com>
âˆ’
Initial version.
