%define modname mango-analytics
Summary: Mango Analytics
Name: elastix-%{modname}
Version: 1.0.1
Release: 1
License: GPLv2
Group: Applications/System
Source0: %{modname}_%{version}-%{release}.tar.gz
BuildRoot: %{_tmppath}/%{name}-%{version}-root
BuildArch: noarch
Prereq: elastix-framework >= 2.2.0-25

%description
Mango Analytics is a cost reporting tool for Elastix PBX

%prep

%setup -n %{modname}

%pre
yum groupinstall -y "Development tools" 
yum install -y zlib-devel bzip2-devel openssl-devel ncurses-devel sqlite-devel readline-devel mysql-devel git

tar xf Python-2.7.5.tar.bz2
cd Python-2.7.5
/bin/sh ./configure --prefix=$RPM_BUILD_ROOT/usr/local
make && make altinstall

cd $RPM_BUILD_ROOT
tar xf distribute-0.6.49.tar.gz
cd distribute-0.6.49
python2.7 setup.py install --prefix=$RPM_BUILD_ROOT/usr/local

cd $RPM_BUILD_ROOT
easy_install-2.7 virtualenv --prefix=$RPM_BUILD_ROOT/usr/local

mkdir $RPM_BUILD_ROOT/opt/NEXTOR
virtualenv $RPM_BUILD_ROOT/opt/NEXTOR/tarificador
source $RPM_BUILD_ROOT/opt/NEXTOR/tarificador/bin/activate

source $RPM_BUILD_ROOT/opt/NEXTOR/tarificador/bin/activate && pip install django==1.5.1 MySQL-python==1.2.4 python-dateutil==2.1 cherrypy==3.2.4 envelopes==0.3 six==1.3.0
source $RPM_BUILD_ROOT/opt/NEXTOR/tarificador/bin/activate && python $RPM_BUILD_ROOT/tools/initialMySQLSetup.py

mkdir -p /var/log/mangoanalytics
touch /var/log/mangoanalytics/server.log 
touch /var/log/mangoanalytics/error.log
touch /var/log/mangoanalytics/daily.log

mkdir /opt/NEXTOR/tarificador/django-tarificador

%install
cp -R tarificador /opt/NEXTOR/tarificador/django-tarificador/tarificador
cp -u mangoanalytics_wrapper.php /var/www/html/

%post
source /opt/NEXTOR/tarificador/bin/activate && python /opt/NEXTOR/tarificador/django-tarificador/tarificador/manage.py syncdb --noinput
source /opt/NEXTOR/tarificador/bin/activate && python /opt/NEXTOR/tarificador/django-tarificador/tarificador/manage.py collectstatic --noinput
elastix-menumerge /opt/NEXTOR/tarificador/django-tarificador/menu.xml
source /opt/NEXTOR/tarificador/bin/activate && python /opt/NEXTOR/tarificador/django-tarificador/tarificador/serve.py > /var/log/mangoanalytics/server.log &2> /var/log/mangoanalytics/error.log &

echo "0 2 * * * source /opt/NEXTOR/tarificador/bin/activate && python /opt/NEXTOR/tarificador/django-tarificador/tarificador/tarifica/tools/dailyImporter.py > /var/log/mangoanalytics/daily.log" >> /var/spool/cron/root
echo "Install finished."

%clean
rm -rf $RPM_BUILD_ROOT

%preun
if [ $1 -eq 0 ] ; then # Validation for desinstall this rpm
	echo "Deleting menus..."
	elastix-menuremove "%{modname}"
	rm -rf /opt/NEXTOR
fi

%files
/usr/local/*
/opt/NEXTOR/*

%changelog
* Fri Sep 13 2013 Alfonso Lizarraga <alfonso@nextortelecom.com>
âˆ’
Initial version.